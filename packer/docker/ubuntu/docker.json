{
  "builders": [
    {
      "name": "build-ubuntu",
      "type": "docker",
      "image": "ubuntu:15.10",
      "pull": true,
      "discard": true
    },
    {
      "name": "release-ubuntu",
      "type": "docker",
      "image": "ubuntu:15.10",
      "pull": true,
      "commit": true
    }
  ],
  "post-processors": [[
    {
      "type": "docker-tag",
      "repository": "contiv/ubuntu1510",
      "tag": "{{ user `version` }}",
      "only": ["build-ubuntu", "release-ubuntu"]
    },
    {
      "type": "docker-push",
      "only": ["release-ubuntu"]
    }
  ]],
  "provisioners": [
    {
      "environment_vars": [
        "http_proxy={{user `http_proxy`}}",
        "https_proxy={{user `https_proxy`}}",
        "ftp_proxy={{user `ftp_proxy`}}",
        "rsync_proxy={{user `rsync_proxy`}}",
        "no_proxy={{user `no_proxy`}}"
      ],
      "execute_command": "echo 'vagrant' | {{.Vars}} sudo -E -S bash '{{.Path}}'",
      "scripts": [
        "../../ubuntu/script/ansible.sh"
      ],
      "type": "shell"
    },
    {
      "type": "ansible-local",
      "playbook_dir": "../../vendor/ansible",
      "playbook_file": "../../vendor/ansible/site.yml",
      "inventory_groups": "devtest",
      "extra_arguments": [
        "--extra-vars",
        "'{\"env\":{ \"http_proxy\":\"{{user `http_proxy`}}\", \"https_proxy\":\"{{user `https_proxy`}}\", \"no_proxy\":\"{{user `no_proxy`}}\", \"ftp_proxy\":\"{{user `ftp_proxy`}}\", \"rsync_proxy\":\"{{user `rsync_proxy`}}\" }, \"validate_certs\":\"no\"}'",
        "--tags",
        "prebake-for-dev,prebake-for-test"
      ]
    }
  ],
  "variables": {
    "ftp_proxy": "{{env `ftp_proxy`}}",
    "http_proxy": "{{env `http_proxy`}}",
    "https_proxy": "{{env `https_proxy`}}",
    "no_proxy": "{{env `no_proxy`}}",
    "rsync_proxy": "{{env `rsync_proxy`}}",
    "ssh_password": "vagrant",
    "ssh_username": "vagrant",
    "atlas_token": "{{ env `atlas_token` }}",
    "version": "{{ env `version` }}"
  }
}
